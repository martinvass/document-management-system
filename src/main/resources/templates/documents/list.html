<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hu">
<head th:replace="~{fragments/header :: html_header(title='DMS - Documents', additionalLinks=~{this::page_links})}">
    <th:block th:fragment="page_links">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <link rel="stylesheet" th:href="@{/css/home.css}">
        <link rel="stylesheet" th:href="@{/css/documents/documents-list.css}">
    </th:block>
</head>
<body>
<nav th:replace="~{fragments/dashboard/navigation :: navigation_bar}"></nav>
<div th:replace="~{fragments/dashboard/sidebar :: sidebar(content=~{::content})}">
    <div th:fragment="content" class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold m-0">Documents</h3>
            <button class="upload-btn" onclick="openUploadModal()" title="Upload document">
                <i class="fa-solid fa-upload"></i>
            </button>
        </div>

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="filter-bar">
            <i class="fa-solid fa-magnifying-glass" style="color: var(--accent); font-size: 1.1rem;"></i>
            <input type="text"
                   class="filter-input"
                   id="searchInput"
                   placeholder="Search documents by name or description..."
                   onkeyup="filterDocuments()">
        </div>

        <div th:if="${#lists.isEmpty(documents)}" class="empty-state">
            <div class="empty-text">No documents yet</div>
        </div>

        <div class="doc-grid" id="docGrid" th:unless="${#lists.isEmpty(documents)}">
            <div th:each="doc : ${documents}"
                 class="doc-card"
                 th:attr="data-name=${doc.originalFilename}, data-desc=${doc.description}, data-id=${doc.id}"
                 onclick="viewDocument(this)">

                <div class="doc-icon">
                    <i th:class="${doc.getIconClass()}"></i>
                </div>

                <div class="doc-header">
                    <div class="doc-name" th:text="${doc.originalFilename}">document.pdf</div>
                    <span class="doc-version-badge" th:text="'v' + ${doc.version}">v1</span>
                    <span class="doc-storage-badge"
                          th:classappend="${doc.storageType.name() == 'CUSTOM_S3' ? 'storage-s3' : 'storage-managed'}"
                          th:title="${doc.storageType.name() == 'CUSTOM_S3' ? 'Stored in S3' : 'Managed storage'}">
                        <i th:class="${doc.storageType.name() == 'CUSTOM_S3' ? 'fa-brands fa-aws' : 'fa-solid fa-database'}"></i>
                        <span th:text="${doc.storageType.name() == 'CUSTOM_S3' ? 'S3' : 'Managed'}">S3</span>
                    </span>
                </div>

                <div class="doc-description" th:text="${doc.description ?: 'No description'}">
                    Document description here...
                </div>

                <div class="doc-meta">
                    <div class="doc-meta-item">
                        <span th:text="${doc.uploadedBy.username}">User</span>
                    </div>
                    <div class="doc-meta-item">
                        <span th:text="${#temporals.format(doc.uploadedAt, 'MMM dd')}">Jan 15</span>
                    </div>
                    <div class="doc-meta-item">
                        <span th:text="${#numbers.formatDecimal(doc.size / 1024.0, 1, 2)} + ' KB'">125.50 KB</span>
                    </div>
                </div>

                <div class="doc-actions" onclick="event.stopPropagation()">
                    <a th:href="@{/documents/{id}/download(id=${doc.id})}"
                       class="icon-btn-circle icon-btn-primary"
                       title="Download">
                        <i class="fa-solid fa-download"></i>
                    </a>
                    <button class="icon-btn-circle icon-btn-outline" title="Share">
                        <i class="fa-solid fa-share"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">Upload Document</h4>
            <button class="modal-close" onclick="closeUploadModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <form th:action="@{/documents/upload}" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">File</label>
                <div class="file-input-wrapper">
                    <label for="fileInput" class="file-input-label">
                        <span id="fileName">Click to select a file</span>
                    </label>
                    <input type="file"
                           id="fileInput"
                           name="file"
                           class="file-input"
                           required
                           onchange="updateFileName(this)">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description (optional)</label>
                <textarea name="description"
                          class="form-control"
                          rows="4"
                          placeholder="Enter a description for this document..."></textarea>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="icon-btn" style="padding: 12px 24px;">
                    Upload
                </button>
                <button type="button"
                        class="icon-btn"
                        onclick="closeUploadModal()"
                        style="padding: 12px 24px;">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function viewDocument(card) {
        const docId = card.getAttribute('data-id');
        window.location.href = '/documents/' + docId;
    }

    function openUploadModal() {
        document.getElementById('uploadModal').classList.add('active');
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('active');
        document.getElementById('fileInput').value = '';
        document.getElementById('fileName').textContent = 'Click to select a file';
    }

    function updateFileName(input) {
        const fileName = input.files[0]?.name || 'Click to select a file';
        document.getElementById('fileName').textContent = fileName;
    }

    function filterDocuments() {
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.doc-card');

        cards.forEach(card => {
            const name = card.getAttribute('data-name')?.toLowerCase() || '';
            const desc = card.getAttribute('data-desc')?.toLowerCase() || '';

            if (name.includes(searchValue) || desc.includes(searchValue)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Close modal on outside click
    document.getElementById('uploadModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUploadModal();
        }
    });
</script>

<div th:replace="~{fragments/scripts :: footer_scripts}"></div>
</body>
</html>