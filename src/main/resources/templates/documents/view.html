<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hu">
<head th:replace="~{fragments/header :: html_header(title='DMS - Document Details', additionalLinks=~{this::page_links})}">
    <th:block th:fragment="page_links">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <link rel="stylesheet" th:href="@{/css/home.css}">
        <link rel="stylesheet" th:href="@{/css/documents/documents-view.css}">
        <style>
            .doc-title-with-lock {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 16px;
            }

            .scroll-to-permissions-btn {
                background: none;
                border: 2px solid #6c757d;
                color: #6c757d;
                padding: 8px 12px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 14px;
            }

            .scroll-to-permissions-btn:hover {
                border-color: #495057;
                color: #495057;
                background: #f8f9fa;
            }

            .autocomplete-dropdown {
                position: absolute;
                background: white;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                max-height: 250px;
                overflow-y: auto;
                width: 100%;
                z-index: 1000;
                display: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .autocomplete-dropdown.show {
                display: block;
            }

            .autocomplete-item {
                padding: 10px 12px;
                cursor: pointer;
                border-bottom: 1px solid #f8f9fa;
            }

            .autocomplete-item:hover {
                background-color: #f8f9fa;
            }

            .selected-user-display {
                display: none;
                margin-top: 8px;
                padding: 8px 12px;
                background-color: #e7f3ff;
                border-radius: 4px;
                border-left: 3px solid #0d6efd;
            }

            .selected-user-display.show {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
        </style>
    </th:block>
</head>
<body>
<nav th:replace="~{fragments/dashboard/navigation :: navigation_bar}"></nav>
<div th:replace="~{fragments/dashboard/sidebar :: sidebar(content=~{::content})}">
    <div th:fragment="content" class="container-fluid py-4">

        <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

        <div class="doc-header">
            <div class="doc-title-section">
                <div class="doc-big-icon">
                    <i th:class="${document.getIconClass()}"></i>
                </div>
                <div class="doc-title-info" style="flex: 1;">
                    <div class="doc-title-with-lock">
                        <div>
                            <div class="doc-title" id="docTitle" th:text="${document.originalFilename}">
                                document.pdf
                            </div>
                            <div>
                                <span class="version-badge-large" th:text="'Version ' + ${document.version}">Version 1</span>
                                <span th:if="${document.isLatestVersion()}" class="status-badge" style="background: #28a745; color: white;">
                                    Latest
                                </span>
                                <span th:unless="${document.isLatestVersion()}" class="status-badge" style="background: #ffc107; color: #000;">
                                    Old Version
                                </span>
                            </div>
                        </div>
                        <!-- SCROLL TO PERMISSIONS BUTTON -->
                        <button class="scroll-to-permissions-btn"
                                th:if="${activeProfile.isCorporationAdmin() or document.uploadedBy.id == activeProfile.user.id}"
                                onclick="scrollToPermissions()"
                                title="Manage Permissions">
                            <i class="fa-solid fa-lock me-1"></i>
                            Permissions
                        </button>
                    </div>
                </div>
            </div>

            <div class="doc-description-box"
                 id="docDescription"
                 contenteditable="false"
                 th:attr="data-doc-id=${document.id}, data-placeholder=${document.description == null or document.description.isEmpty()}"
                 onclick="enableEdit('docDescription')"
                 onblur="saveDescription()">
                <span th:if="${document.description != null and !document.description.isEmpty()}"
                      th:text="${document.description}">Description here</span>
                <span th:unless="${document.description != null and !document.description.isEmpty()}"
                      class="description-placeholder">Click to add description...</span>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Uploaded By</div>
                    <div class="info-value" th:text="${document.uploadedBy.username}">username</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Upload Date</div>
                    <div class="info-value" th:text="${#temporals.format(document.uploadedAt, 'MMM dd, yyyy HH:mm')}">Jan 15, 2024 14:30</div>
                </div>
                <div class="info-item">
                    <div class="info-label">File Size</div>
                    <div class="info-value" th:text="${#numbers.formatDecimal(document.size / 1024.0, 1, 2)} + ' KB'">125.50 KB</div>
                </div>
                <div class="info-item">
                    <div class="info-label">File Type</div>
                    <div class="info-value" th:text="${document.contentType}">application/pdf</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Storage</div>
                    <div class="info-value">
                        <span class="storage-type-badge"
                              th:classappend="${document.storageType != null and document.storageType.name() == 'CUSTOM_S3' ? 'storage-s3' : 'storage-managed'}">
                            <i th:class="${document.storageType != null and document.storageType.name() == 'CUSTOM_S3' ? 'fa-brands fa-aws' : 'fa-solid fa-database'}"></i>
                            <span th:text="${document.storageType != null and document.storageType.name() == 'CUSTOM_S3' ? 'Amazon S3' : 'Managed Storage'}">S3</span>
                        </span>
                    </div>
                </div>
            </div>

            <div class="action-buttons mt-4">
                <a th:href="@{/documents/{id}/download(id=${document.id})}" class="action-btn">
                    <i class="fa-solid fa-download"></i> Download
                </a>
                <button class="action-btn action-btn-secondary"
                        th:if="${document.isLatestVersion()}"
                        onclick="openVersionModal()">
                    <i class="fa-solid fa-upload"></i> Upload New Version
                </button>
                <button class="action-btn action-btn-warning"
                        th:if="${document.storageType != null and currentStorageType != null and document.storageType != currentStorageType}"
                        onclick="openMigrationModal()"
                        th:title="'Migrate from ' + ${document.storageType.name()} + ' to ' + ${currentStorageType.name()}">
                    <i class="fa-solid fa-arrow-right-arrow-left"></i> Migrate Storage
                </button>
                <a th:href="@{/documents}" class="action-btn action-btn-secondary">
                    <i class="fa-solid fa-arrow-left-long"></i> Back to List
                </a>
                <form th:action="@{/documents/{id}/archive(id=${document.id})}"
                      method="post" style="display: inline;">
                    <button type="submit"
                            class="action-btn action-btn-danger"
                            onclick="return confirm('Archive this document?')">
                        <i class="fa-solid fa-box-archive"></i> Archive
                    </button>
                </form>
            </div>
        </div>

        <!-- Version History -->
        <div class="version-section" th:if="${versions.size() > 1}">
            <h4 class="section-title">
                <i class="fa-solid fa-clock-rotate-left"></i> Version History
            </h4>
            <div class="timeline">
                <div th:each="ver : ${versions}"
                     th:class="${ver.id == document.id} ? 'timeline-item current' : 'timeline-item'">
                    <div class="timeline-dot" th:text="${ver.version}">1</div>
                    <div class="timeline-content">
                        <div class="timeline-info">
                            <h4>
                                Version <span th:text="${ver.version}">1</span>
                                <span th:if="${ver.id == document.id}" class="badge bg-success ms-2">Viewing</span>
                                <span th:if="${ver.isLatestVersion()}" class="badge bg-primary ms-2">Latest</span>
                            </h4>
                            <div class="timeline-meta">
                                <span th:text="${ver.originalFilename}">file.pdf</span>
                                <span th:text="${#temporals.format(ver.uploadedAt, 'MMM dd, yyyy HH:mm')}">Jan 15, 2024</span>
                                <span th:text="${#numbers.formatDecimal(ver.size / 1024.0, 1, 2)} + ' KB'">125.50 KB</span>
                            </div>
                        </div>
                        <div class="timeline-actions">
                            <a th:href="@{/documents/{id}(id=${ver.id})}"
                               th:if="${ver.id != document.id}"
                               class="icon-btn-small icon-btn-outline">View</a>
                            <a th:href="@{/documents/{id}/download(id=${ver.id})}"
                               class="icon-btn-small">Download</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="permissionsSection"
             class="card p-0 mt-4"
             th:if="${activeProfile.isCorporationAdmin() or document.uploadedBy.id == activeProfile.user.id}">

            <div class="p-4 border-bottom" style="background-color: var(--accent);">
                <h5 class="fw-semibold mb-0 text-white">
                    <i class="fa-solid fa-lock me-2"></i>Permission Control
                </h5>
            </div>

            <div class="p-4">

                <!-- Simple Bootstrap Tabs -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-departments">
                            <i class="fas fa-building me-1"></i> Departments
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-users">
                            <i class="fas fa-user me-1"></i> Individual Users
                        </button>
                    </li>
                </ul>

                <div class="tab-content">

                    <!-- DEPARTMENTS TAB -->
                    <div class="tab-pane fade show active" id="tab-departments">
                        <p class="text-muted mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            All members of these departments will automatically have READ access.
                        </p>

                        <!-- Current departments -->
                        <div class="mb-4" th:if="${document.departments != null and !#lists.isEmpty(document.departments)}">
                            <h6 class="fw-bold mb-3">Current Departments</h6>
                            <div class="list-group">
                                <div th:each="dept : ${document.departments}"
                                     class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong th:text="${dept.name}">IT Department</strong>
                                        <small class="d-block text-muted" th:text="${dept.description}">Description</small>
                                    </div>
                                    <form th:action="@{/documents/{id}/permissions/remove-department(id=${document.id})}"
                                          method="post" class="d-inline">
                                        <input type="hidden" name="departmentId" th:value="${dept.id}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Remove department access?')">
                                            <i class="fas fa-times"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Add department form -->
                        <div th:if="${allDepartments != null and !#lists.isEmpty(allDepartments)}">
                            <h6 class="fw-bold mb-3">Add Department</h6>
                            <form th:action="@{/documents/{id}/permissions/add-department(id=${document.id})}"
                                  method="post" class="row g-3">
                                <div class="col-md-9">
                                    <select name="departmentId" class="form-select" required>
                                        <option value="">-- Select Department --</option>
                                        <option th:each="dept : ${allDepartments}"
                                                th:value="${dept.id}"
                                                th:text="${dept.name}"
                                                th:disabled="${document.departments != null and document.departments.contains(dept)}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-1"></i> Add
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- INDIVIDUAL USERS TAB -->
                    <div class="tab-pane fade" id="tab-users">

                        <!-- Current permissions table -->
                        <div class="mb-4" th:if="${permissions != null and !#lists.isEmpty(permissions)}">
                            <h6 class="fw-bold mb-3">Current Permissions</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Email</th>
                                        <th>Level</th>
                                        <th>Granted By</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="perm : ${permissions}">
                                        <td>
                                            <strong th:text="${perm.profile.user.profile.firstName + ' ' + perm.profile.user.profile.lastName}">
                                                John Doe
                                            </strong>
                                        </td>
                                        <td th:text="${perm.profile.user.profile.email}">john@example.com</td>
                                        <td>
                                                <span class="badge"
                                                      th:classappend="${perm.permissionLevel.name() == 'ADMIN' ? 'bg-danger' :
                                                                        (perm.permissionLevel.name() == 'EDIT' ? 'bg-warning text-dark' : 'bg-success')}"
                                                      th:text="${perm.permissionLevel}">READ</span>
                                        </td>
                                        <td th:text="${perm.grantedBy.profile.username}">admin</td>
                                        <td>
                                            <form th:action="@{/documents/{id}/permissions/revoke-user(id=${document.id})}"
                                                  method="post" class="d-inline">
                                                <input type="hidden" name="profileId" th:value="${perm.profile.id}"/>
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        onclick="return confirm('Revoke permission?')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Grant permission form -->
                        <div>
                            <h6 class="fw-bold mb-3">Grant Permission to User</h6>
                            <form th:action="@{/documents/{id}/permissions/grant-user(id=${document.id})}"
                                  method="post" th:attr="data-doc-id=${document.id}">

                                <!-- User search with autocomplete -->
                                <div class="mb-3">
                                    <label class="form-label">Search User</label>
                                    <div style="position: relative;">
                                        <input type="text"
                                               id="userSearch"
                                               class="form-control"
                                               placeholder="Type name or email..."
                                               autocomplete="off">
                                        <div id="userAutocomplete" class="autocomplete-dropdown"></div>
                                    </div>
                                    <div id="selectedUser" class="selected-user-display">
                                        <span id="selectedUserName"></span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearUser()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" id="profileId" name="profileId" required>
                                </div>

                                <!-- Permission level -->
                                <div class="mb-3">
                                    <label class="form-label">Permission Level</label>
                                    <select name="permissionLevel" class="form-select" required>
                                        <option value="READ">READ - Can view and download</option>
                                        <option value="EDIT">EDIT - Can modify</option>
                                        <option value="ADMIN">ADMIN - Full control</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-check me-1"></i> Grant Permission
                                </button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- Version upload modal -->
<div id="versionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">Upload New Version</h4>
            <button class="modal-close" onclick="closeVersionModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <form th:action="@{/documents/{id}/new-version(id=${document.id})}"
              method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label">File</label>
                <div class="file-input-wrapper">
                    <label for="versionFile" class="file-input-label">
                        <span id="versionFileName">Click to select a file</span>
                    </label>
                    <input type="file" id="versionFile" name="file" class="file-input" required
                           onchange="updateVersionFileName(this)">
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="action-btn action-btn-secondary">Upload</button>
                <button type="button" class="action-btn action-btn-secondary" onclick="closeVersionModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="migrationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 class="modal-title">Migrate Storage</h4>
            <button class="modal-close" onclick="closeMigrationModal()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>This will migrate the document storage.</p>
        </div>
        <form id="migrationForm" th:action="@{/documents/{id}/migrate(id=${document.id})}" method="post">
            <div class="d-flex gap-2">
                <button type="button" class="action-btn action-btn-warning" onclick="confirmMigration()">
                    <i class="fa-solid fa-arrow-right-arrow-left"></i> Migrate
                </button>
                <button type="button" class="action-btn action-btn-secondary" onclick="closeMigrationModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    let searchTimeout;

    document.getElementById('userSearch')?.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();

        if (query.length < 2) {
            document.getElementById('userAutocomplete').classList.remove('show');
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/corporation/users/search?query=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(users => {
                    const dropdown = document.getElementById('userAutocomplete');
                    if (users.length === 0) {
                        dropdown.innerHTML = '<div class="autocomplete-item">No users found</div>';
                    } else {
                        dropdown.innerHTML = users.map(u =>
                            `<div class="autocomplete-item" onclick="selectUser(${u.profileId}, '${u.firstName}', '${u.lastName}', '${u.email}')">
                                <strong>${u.firstName} ${u.lastName}</strong><br>
                                <small class="text-muted">${u.email}</small>
                            </div>`
                        ).join('');
                    }
                    dropdown.classList.add('show');
                });
        }, 300);
    });

    function selectUser(id, firstName, lastName, email) {
        document.getElementById('profileId').value = id;
        document.getElementById('selectedUserName').textContent = `${firstName} ${lastName} (${email})`;
        document.getElementById('selectedUser').classList.add('show');
        document.getElementById('userSearch').value = '';
        document.getElementById('userAutocomplete').classList.remove('show');
    }

    function clearUser() {
        document.getElementById('profileId').value = '';
        document.getElementById('selectedUser').classList.remove('show');
    }

    // Scroll to permissions
    function scrollToPermissions() {
        document.getElementById('permissionsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Close dropdown on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#userSearch')) {
            document.getElementById('userAutocomplete')?.classList.remove('show');
        }
    });

    // Other functions
    function enableEdit(elementId) {
        const element = document.getElementById(elementId);
        element.contentEditable = 'true';
        element.classList.add('editing');
        element.focus();
    }

    function saveDescription() {
        const element = document.getElementById('docDescription');
        element.contentEditable = 'false';
        element.classList.remove('editing');
        const docId = element.getAttribute('data-doc-id');
        const newDescription = element.textContent.trim();
        fetch(`/documents/${docId}/update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `description=${encodeURIComponent(newDescription)}`
        }).then(response => {
            if (response.ok && !newDescription) {
                element.innerHTML = '<span class="description-placeholder">Click to add description...</span>';
            }
        });
    }

    function openVersionModal() { document.getElementById('versionModal').classList.add('active'); }
    function closeVersionModal() { document.getElementById('versionModal').classList.remove('active'); }
    function updateVersionFileName(input) {
        document.getElementById('versionFileName').textContent = input.files[0]?.name || 'Click to select a file';
    }
    function openMigrationModal() { document.getElementById('migrationModal').classList.add('active'); }
    function closeMigrationModal() { document.getElementById('migrationModal').classList.remove('active'); }
    function confirmMigration() { document.getElementById('migrationForm').submit(); }
</script>

<div th:replace="~{fragments/scripts :: footer_scripts}"></div>
</body>
</html>