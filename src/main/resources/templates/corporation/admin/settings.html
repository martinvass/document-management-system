<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hu">
<head th:replace="~{fragments/header :: html_header(title='DMS - Company Settings', additionalLinks=~{this::page_links})}">
    <th:block th:fragment="page_links">
        <link rel="stylesheet" th:href="@{/css/dashboard.css}">
        <link rel="stylesheet" th:href="@{/css/home.css}">
        <link rel="stylesheet" th:href="@{/css/company/settings.css}">
    </th:block>
</head>
<body>

<nav th:replace="~{fragments/dashboard/navigation :: navigation_bar}"></nav>

<div th:replace="~{fragments/dashboard/sidebar :: sidebar(content=~{::content})}">
    <div th:fragment="content">
        <div class="container-fluid py-4">

            <h3 class="fw-bold mb-4">Settings</h3>

            <!-- Tabs -->
            <div class="settings-tabs">
                <div class="settings-tab active" data-tab="general">General</div>
                <div class="settings-tab" data-tab="storage">Storage</div>
            </div>

            <div class="tab-content active" id="tab-general">
                <form th:action="@{settings/general}" method="post" th:object="${general}">
                    <div class="section-title">General settings</div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Company name</label>
                            <input th:field="*{name}" class="form-control">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Description</label>
                            <input th:field="*{description}" class="form-control">
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-primary" type="submit">Save changes</button>
                    </div>
                </form>
            </div>

            <div class="tab-content" id="tab-storage">
                <form th:action="@{settings/storage}" method="post" th:object="${storage}">
                    <div class="section-title">Document storage</div>
                    <div class="section-desc">
                        Select where your company documents should be stored.
                    </div>

                    <div class="radio-group">
                        <label class="radio-box">
                            <input type="radio" th:field="*{storageType}" value="MANAGED"> Managed storage
                        </label>
                        <label class="radio-box">
                            <input type="radio" th:field="*{storageType}" value="CUSTOM_S3"> Custom AWS S3
                        </label>
                    </div>

                    <div id="aws-fields">
                        <div class="section-title">AWS S3 configuration</div>
                        <div class="section-desc">
                            Use a dedicated IAM user with restricted permissions.
                        </div>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label">Region</label>
                                <input th:field="*{s3Region}" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Bucket name</label>
                                <input th:field="*{s3Bucket}" class="form-control">
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Bucket prefix</label>
                                <input th:field="*{s3Prefix}" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Access key ID</label>
                                <input name="s3AccessKey" type="password" class="form-control" th:placeholder="${storage.hasStoredCredentials} ? '******** (stored)' : '********'">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Secret access key</label>
                                <input name="s3SecretKey" type="password" class="form-control" th:placeholder="${storage.hasStoredCredentials} ? '******** (stored)' : '********'">
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-primary" type="submit">Save changes</button>

                        <button class="btn-secondary"
                                type="submit"
                                id="testConnectionBtn"
                                th:formaction="@{settings/storage/test}"
                                th:formmethod="post"
                                formnovalidate>
                            Test connection
                        </button>
                    </div>
                </form>

                <div th:if="${storageTestSuccess}" class="connection-success">
                    <i class="fas fa-check-circle"></i> Connection successful
                </div>

                <div th:if="${storageTestError}" class="connection-failed">
                    <i class="fas fa-times-circle"></i> Connection failed
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragments/scripts :: footer_scripts}"></div>

<script>
    const tabs = document.querySelectorAll('.settings-tab');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
    });

    function toggleAws() {
        const managed = document.querySelector('input[value="MANAGED"]').checked;
        const testBtn = document.getElementById('testConnectionBtn');

        document.getElementById('aws-fields').classList.toggle('disabled', managed);
        testBtn.disabled = managed;
    }

    document.querySelectorAll('input[name="storageType"]').forEach(r => {
        r.addEventListener('change', toggleAws);
    });

    toggleAws();
</script>

</body>
</html>